#textdomain wesnoth-The_Haunted_Woods

#define EQUIPMENT_SHOP X Y
    [label]
        x,y={X},{Y}
        text = "<b>Enhancements</b>"
        immutable=yes
    [/label]
    [item]
        x={X}
        y={Y}
        image=scenery/temple1.png
        halo=halo/elven/elven-shield-halo-80pct.png
    [/item]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x={X}
            y={Y}
            side=1,2,3
        [/filter]
        {VARIABLE finished no}
        [store_side]
            side=$unit.side
            variable=stored_unit_side
            mode=replace
        [/store_side]
        [if]
            [variable]
                name=stored_unit_side.controller
                equals=ai
            [/variable]
            [then]
                {VARIABLE finished yes}
            [/then]
        [/if]
        [store_unit]
            [filter]
                x={X}
                y={Y}
            [/filter]
            variable=shopper
        [/store_unit]
        {VARIABLE temp_upgrades_variable $shopper.variables.upgrades_available}
        [unstore_unit]
            variable=shopper
        [/unstore_unit]
        [if]
            [variable]
                name=temp_upgrades_variable
                equals=0
            [/variable]
            [then]
                {NARRATOR_MESSAGE_THW $side_number ( _ "$shopper.name| has reached his upgrade limit. He can buy no more upgrades.")}
            [/then]
            [else]
                [if]
                    [variable]
                        name=shopper.variables.original_leader
                        equals=yes
                    [/variable]
                    [then]
                        {NARRATOR_MESSAGE_THW $side_number ( _ "Welcome back! I've opened up my special wares to you today. To see them, select the option '<i>See exclusive wares</i>'. You are the only person who will ever be able to purchase these upgrades, so be careful.")}
                    [/then]
                [/if]
            [/else]
        [/if]
        [while]
            [variable]
                name=finished
                equals=no
            [/variable]
            [variable]
                name=temp_upgrades_variable
                greater_than=0
            [/variable]
            [do]
                [store_unit]
                    [filter]
                        x={X}
                        y={Y}
                    [/filter]
                    variable=shopper
                [/store_unit]
                {VARIABLE temp_upgrades_variable $shopper.variables.upgrades_available}
                [unstore_unit]
                    variable=shopper
                [/unstore_unit]
                [store_side]
                    side=$unit.side
                    variable=stored_unit_side
                    mode=replace
                [/store_side]
                [message]
                    speaker=narrator
                    image=wesnoth-icon.png
                    message= _ "Please choose an enhancement, $unit.name.
<b>Current gold: <span foreground='green'>$stored_unit_side.gold|</span>
You have <span foreground='red'>$temp_upgrades_variable|</span> upgrades remaining</b>"
                    [option]
                        message= _ "<b>I'm Finished.</b>"
                        [command]
                            {PRINT_THW (Please come back again soon!)}
                            {VARIABLE finished yes}
                            {CLEAR_VARIABLE stored_unit_side}
                            {CLEAR_VARIABLE temp_upgrades_variable}
                        [/command]
                    [/option]
                    [option]
                        message={MENU_IMG_TXT2 ($shopper.image) ( _ "<big><i><span foreground='yellow'>See exclusive wares</span></i></big>") ( _ "Allows you to buy special upgrades")}
                        [show_if]
                            [have_unit]
                                x={X}
                                y={Y}
                                side=1
                                [filter_wml]
                                    [variables]
                                        original_leader=yes
                                    [/variables]
                                [/filter_wml]
                            [/have_unit]
                        [/show_if]
                        [command]
                            {VARIABLE finished_sub no}
                            [while]
                                [variable]
                                    name=finished_sub
                                    equals=no
                                [/variable]
                                [variable]
                                    name=temp_upgrades_variable
                                    greater_than=0
                                [/variable]
                                [do]
                                    [store_side]
                                        side=$unit.side
                                        variable=stored_unit_side
                                        mode=replace
                                    [/store_side]
                                    [store_unit]
                                        [filter]
                                            x={X}
                                            y={Y}
                                        [/filter]
                                        variable=shopper
                                    [/store_unit]
                                    {VARIABLE temp_upgrades_variable $shopper.variables.upgrades_available}
                                    [unstore_unit]
                                        variable=shopper
                                    [/unstore_unit]
                                    [message]
                                        speaker=narrator
                                        image=wesnoth-icon.png
                                        message= _ "Please choose an enhancement, $unit.name.
<b>Current gold: <span foreground='green'>$stored_unit_side.gold|</span>
You have <span foreground='red'>$temp_upgrades_variable|</span> upgrades remaining</b>"
                                        [option]
                                            message={MENU_IMG_TXT (units/elves-wood/archer-sword-1.png) ( _ "<big><i><span foreground='yellow'>See the regular upgrades</span></i></big>")}
                                            [command]
                                                {VARIABLE finished_sub yes}
                                            [/command]
                                        [/option]
                                        [option]
                                            message={MENU_IMG_TXT2 (attacks/bow-elven-magic.png) (<big>Let me shoot my bow with greater accuracy: 40 coins</big>) (This unit will receive the marksman special on her bow)}
                                            [command]
                                                [if]
                                                    [variable]
                                                        name=stored_unit_side.gold
                                                        greater_than_equal_to=40
                                                    [/variable]
                                                    [then]
                                                        [gold]
                                                            side=$side_number
                                                            amount=-40
                                                        [/gold]
                                                        [object]
                                                            silent=yes
                                                            [filter]
                                                                x={X}
                                                                y={Y}
                                                            [/filter]
                                                            [effect]
                                                                apply_to=attack
                                                                name=bow
                                                                [set_specials]
                                                                    {WEAPON_SPECIAL_MARKSMAN}
                                                                [/set_specials]
                                                            [/effect]
                                                        [/object]
                                                        {THW_UPGRADE_BOUGHT}
                                                    [/then]
                                                    [else]
                                                        {PRINT_THW (You don't have enough gold!)}
                                                    [/else]
                                                [/if]
                                            [/command]
                                        [/option]

                                        [option]
                                            message={MENU_IMG_TXT2 (attacks/faerie-fire.png) (<big>Teach me a powerful new spell: 75 coins</big>) (This unit will learn faerie fire, a 6-4 magical arcane ranged attack)}
                                            [command]
                                                [if]
                                                    [variable]
                                                        name=stored_unit_side.gold
                                                        greater_than_equal_to=75
                                                    [/variable]
                                                    [then]
                                                        [gold]
                                                            side=1
                                                            amount=-75
                                                        [/gold]
                                                        [object]
                                                            [filter]
                                                                x={X}
                                                                y={Y}
                                                            [/filter]

                                                            silent=yes

                                                            [effect]
                                                                apply_to=new_attack
                                                                name=faerie fire
                                                                description= _ "Faerie Fire"
                                                                type=arcane
                                                                range=ranged
                                                                damage=6
                                                                number=4
                                                                [specials]
                                                                    {WEAPON_SPECIAL_MAGICAL}
                                                                [/specials]
                                                                icon=attacks/faerie-fire.png
                                                            [/effect]
                                                        [/object]
                                                        [object]
                                                            silent=yes
                                                            [effect]
                                                                apply_to=new_animation
                                                                name=faerie fire
                                                                [attack_anim]
                                                                    [filter_attack]
                                                                        name=faerie fire
                                                                    [/filter_attack]
                                                                    {MISSILE_FRAME_FAERIE_FIRE}
                                                                    [if]
                                                                        hits=yes
                                                                        [frame]
                                                                            begin=-450
                                                                            end=-375
                                                                            sound=magic-faeriefire.ogg
                                                                            halo=halo/elven/faerie-fire-halo1.png
                                                                            halo_x,halo_y=0,-35
                                                                        [/frame]
                                                                    [/if]
                                                                    [else]
                                                                        hits=no
                                                                        [frame]
                                                                            begin=-450
                                                                            end=-375
                                                                            sound=magic-faeriefire-miss.ogg
                                                                            halo=halo/elven/faerie-fire-halo1.png
                                                                            halo_x,halo_y=0,-35
                                                                        [/frame]
                                                                    [/else]
                                                                    [frame]
                                                                        begin=-375
                                                                        end=-300
                                                                        halo=halo/elven/faerie-fire-halo2.png
                                                                        halo_x,halo_y=0,-35
                                                                    [/frame]
                                                                    [frame]
                                                                        begin=-300
                                                                        end=-225
                                                                        halo=halo/elven/faerie-fire-halo3.png
                                                                        halo_x,halo_y=0,-35
                                                                    [/frame]
                                                                    [frame]
                                                                        begin=-225
                                                                        end=-150
                                                                        halo=halo/elven/faerie-fire-halo4.png
                                                                        halo_x,halo_y=0,-35
                                                                    [/frame]
                                                                    [frame]
                                                                        begin=-150
                                                                        end=-75
                                                                        halo=halo/elven/faerie-fire-halo5.png
                                                                        halo_x,halo_y=0,-35
                                                                    [/frame]
                                                                    [frame]
                                                                        begin=-75
                                                                        end=0
                                                                        halo=halo/elven/faerie-fire-halo6.png
                                                                        halo_x,halo_y=0,-35
                                                                    [/frame]
                                                                    [frame]
                                                                        begin=-0
                                                                        end=75
                                                                        halo=halo/elven/faerie-fire-halo7.png
                                                                        halo_x,halo_y=0,-35
                                                                    [/frame]
                                                                [/attack_anim]
                                                            [/effect]
                                                        [/object]
                                                        {THW_UPGRADE_BOUGHT}
                                                    [/then]
                                                    [else]
                                                        {PRINT_THW (You don't have enough gold!)}
                                                    [/else]
                                                [/if]
                                            [/command]
                                        [/option]

                                        [option]
                                            message={MENU_IMG_TXT2 (attacks/web.png) (<big>Teach me a spell I can use to slow others: 50 coins</big>) (This unit will learn entangle, a 4-3 ranged impact attack that slows enemies)}
                                            [command]
                                                [if]
                                                    [variable]
                                                        name=stored_unit_side.gold
                                                        greater_than_equal_to=50
                                                    [/variable]
                                                    [then]
                                                        [gold]
                                                            side=1
                                                            amount=-50
                                                        [/gold]
                                                        [object]
                                                            silent=yes
                                                            [filter]
                                                                x={X}
                                                                y={Y}
                                                            [/filter]
                                                            [effect]
                                                                apply_to=new_attack
                                                                name=entangle
                                                                description= _ "entangle"
                                                                type=impact
                                                                range=ranged
                                                                damage=4
                                                                number=3
                                                                [specials]
                                                                    {WEAPON_SPECIAL_SLOW}
                                                                [/specials]
                                                                icon=attacks/entangle.png
                                                            [/effect]
                                                            [effect]
                                                                apply_to=new_animation
                                                                name=entangle
                                                                [filter_attack]
                                                                    name=entangle
                                                                [/filter_attack]
                                                                [attack_anim]
                                                                    [missile_frame]
                                                                        offset=1.0
                                                                        begin=-200
                                                                        end=0
                                                                        image="projectiles/entangle.png"
                                                                        image_diagonal="projectiles/entangle.png"
                                                                    [/missile_frame]
                                                                    {SOUND:SLOW}
                                                                [/attack_anim]
                                                            [/effect]
                                                        [/object]
                                                        {THW_UPGRADE_BOUGHT}
                                                    [/then]
                                                    [else]
                                                        {PRINT_THW (You don't have enough gold!)}
                                                    [/else]
                                                [/if]
                                            [/command]
                                        [/option]
                                    [/message]
                                [/do]
                            [/while]
                        [/command]
                    [/option]

                    [option]
                        message={MENU_IMG_TXT2 ($shopper.image) ( _ "<big><i><span foreground='yellow'>See exclusive wares</span></i></big>") ( _ "Allows you to buy special upgrades")}
                        [show_if]
                            [have_unit]
                                x={X}
                                y={Y}
                                side=2
                                [filter_wml]
                                    [variables]
                                        original_leader=yes
                                    [/variables]
                                [/filter_wml]
                            [/have_unit]
                        [/show_if]
                        [command]
                            {VARIABLE finished_sub no}
                            [while]
                                [variable]
                                    name=finished_sub
                                    equals=no
                                [/variable]
                                [variable]
                                    name=temp_upgrades_variable
                                    greater_than=0
                                [/variable]
                                [do]
                                    [store_side]
                                        side=$unit.side
                                        variable=stored_unit_side
                                        mode=replace
                                    [/store_side]
                                    [store_unit]
                                        [filter]
                                            x={X}
                                            y={Y}
                                        [/filter]
                                        variable=shopper
                                    [/store_unit]
                                    {VARIABLE temp_upgrades_variable $shopper.variables.upgrades_available}
                                    [unstore_unit]
                                        variable=shopper
                                    [/unstore_unit]
                                    [message]
                                        speaker=narrator
                                        image=wesnoth-icon.png
                                        message= _ "Please choose an enhancement, $unit.name.
<b>Current gold: <span foreground='green'>$stored_unit_side.gold|</span>
You have <span foreground='red'>$temp_upgrades_variable|</span> upgrades remaining</b>"
                                        [option]
                                            message={MENU_IMG_TXT (units/dwarves/guard-defend-1.png) ( _ "<big><i><span foreground='yellow'>See the regular upgrades</span></i></big>")}
                                            [command]
                                                {VARIABLE finished_sub yes}
                                            [/command]
                                        [/option]
                                        [option]
                                            message={MENU_IMG_TXT2 (attacks/hammer.png) (<big>I would like to have a hammer: 55 gold</big>) (This unit will learn how to use a hammer, a 10-2 impact melee attack)}
                                            [command]
                                                [if]
                                                    [variable]
                                                        name=stored_unit_side.gold
                                                        greater_than_equal_to=55
                                                    [/variable]
                                                    [then]
                                                        [gold]
                                                            side=2
                                                            amount=-55
                                                        [/gold]
                                                        [object]
                                                            silent=yes
                                                            [filter]
                                                                x={X}
                                                                y={Y}
                                                            [/filter]
                                                            [effect]
                                                                apply_to=new_attack
                                                                name=hammer
                                                                description= _ "hammer"
                                                                type=impact
                                                                range=melee
                                                                damage=10
                                                                number=2
                                                            [/effect]
                                                        [/object]
                                                        [object]
                                                            silent=yes
                                                            [effect]
                                                                apply_to=new_animation
                                                                name=hammer
                                                                [attack_anim]
                                                                    [filter_attack]
                                                                        name=hammer
                                                                    [/filter_attack]
                                                                    [frame]
                                                                        begin=-200
                                                                        end=-150
                                                                    [/frame]
                                                                    [frame]
                                                                        begin=-150
                                                                        end=-100
                                                                    [/frame]
                                                                    [if]
                                                                        hits=yes
                                                                        [frame]
                                                                            begin=-100
                                                                            end=50
                                                                            sound=mace.wav
                                                                        [/frame]
                                                                    [/if]
                                                                    [else]
                                                                        hits=no
                                                                        [frame]
                                                                            begin=-100
                                                                            end=50
                                                                            sound=miss-1.ogg
                                                                        [/frame]
                                                                    [/else]
                                                                    [frame]
                                                                        begin=50
                                                                        end=75
                                                                    [/frame]
                                                                    [frame]
                                                                        begin=75
                                                                        end=150
                                                                    [/frame]
                                                                [/attack_anim]
                                                            [/effect]
                                                        [/object]
                                                        {THW_UPGRADE_BOUGHT}
                                                    [/then]
                                                    [else]
                                                        {PRINT_THW (You don't have enough gold!)}
                                                    [/else]
                                                [/if]
                                            [/command]
                                        [/option]

                                        [option]
                                            message={MENU_IMG_TXT2 (attacks/cleaver.png) (<big>Give me extremely good resistances on defense: 50 coins</big>) (This unit will gain the steadfast ability)}
                                            [command]
                                                [if]
                                                    [variable]
                                                        name=stored_unit_side.gold
                                                        greater_than_equal_to=50
                                                    [/variable]
                                                    [then]
                                                        [gold]
                                                            side=2
                                                            amount=-50
                                                        [/gold]
                                                        [object]
                                                            silent=yes
                                                            [filter]
                                                                x={X}
                                                                y={Y}
                                                            [/filter]
                                                            [effect]
                                                                apply_to=new_ability
                                                                [abilities]
                                                                    {ABILITY_STEADFAST}
                                                                [/abilities]
                                                            [/effect]
                                                        [/object]
                                                        {THW_UPGRADE_BOUGHT}
                                                    [/then]
                                                    [else]
                                                        {PRINT_THW (You don't have enough gold!)}
                                                    [/else]
                                                [/if]
                                            [/command]
                                        [/option]
                                        [option]
                                            message={MENU_IMG_TXT2 (attacks/thunderstick.png) (<big>Give me a thunderstick: 65 coins</big>) (This unit will learn how to use a thunderstick, a 18-1 pierce ranged attack)}
                                            [command]
                                                [if]
                                                    [variable]
                                                        name=stored_unit_side.gold
                                                        greater_than_equal_to=65
                                                    [/variable]
                                                    [then]
                                                        [gold]
                                                            side=2
                                                            amount=-65
                                                        [/gold]
                                                        [object]
                                                            silent=yes
                                                            [filter]
                                                                x={X}
                                                                y={Y}
                                                            [/filter]
                                                            [effect]
                                                                apply_to=new_attack
                                                                name=thunderstick
                                                                description= _ "thunderstick"
                                                                range=ranged
                                                                type=pierce
                                                                damage=18
                                                                number=1
                                                            [/effect]
                                                        [/object]
                                                        [if]
                                                            [have_unit]
                                                                x={X}
                                                                y={Y}
                                                                type=Dwarvish Stalwart
                                                            [/have_unit]
                                                            [then]
                                                                [object]
                                                                    silent=yes
                                                                    [effect]
                                                                        apply_to=new_animation
                                                                        name=thunderstick
                                                                        [attack_anim]
                                                                            [filter_attack]
                                                                                name=thunderstick
                                                                            [/filter_attack]
                                                                            [if]
                                                                                {MISSILE_FRAME_MUZZLE_FLARE_HIT_SOUTH 0 0}
                                                                                direction=s
                                                                                hits=yes
                                                                                [frame]
                                                                                    begin=-400
                                                                                    end=0
                                                                                    sound=thunderstick.ogg
                                                                                [/frame]
                                                                            [/if]
                                                                            [else]
                                                                                {MISSILE_FRAME_MUZZLE_FLARE_MISS}
                                                                                direction=s
                                                                                hits=no
                                                                                [frame]
                                                                                    begin=-400
                                                                                    end=0
                                                                                    sound=thunderstick-miss.ogg
                                                                                [/frame]
                                                                            [/else]
                                                                            [else]
                                                                                {MISSILE_FRAME_MUZZLE_FLARE_HIT_DIAG_NORTH 0 20}
                                                                                direction=ne,nw
                                                                                hits=yes
                                                                                [frame]
                                                                                    begin=-400
                                                                                    end=0
                                                                                    sound=thunderstick.ogg
                                                                                [/frame]
                                                                            [/else]
                                                                            [else]
                                                                                {MISSILE_FRAME_MUZZLE_FLARE_MISS}
                                                                                direction=ne,nw
                                                                                hits=no
                                                                                [frame]
                                                                                    begin=-400
                                                                                    end=0
                                                                                    sound=thunderstick-miss.ogg
                                                                                [/frame]
                                                                            [/else]
                                                                            [else]
                                                                                {MISSILE_FRAME_MUZZLE_FLARE_HIT_NORTH 0 20}
                                                                                direction=n
                                                                                hits=yes
                                                                                [frame]
                                                                                    begin=-400
                                                                                    end=0
                                                                                    sound=thunderstick.ogg
                                                                                [/frame]
                                                                            [/else]
                                                                            [else]
                                                                                {MISSILE_FRAME_MUZZLE_FLARE_MISS}
                                                                                direction=n
                                                                                hits=no
                                                                                [frame]
                                                                                    begin=-400
                                                                                    end=0
                                                                                    sound=thunderstick-miss.ogg
                                                                                [/frame]
                                                                            [/else]
                                                                            [else]
                                                                                {MISSILE_FRAME_MUZZLE_FLARE_HIT_DIAG_SOUTH 0 0}
                                                                                direction=se,sw
                                                                                hits=yes
                                                                                [frame]
                                                                                    begin=-400
                                                                                    end=0
                                                                                    sound=thunderstick.ogg
                                                                                [/frame]
                                                                            [/else]
                                                                            [else]
                                                                                {MISSILE_FRAME_MUZZLE_FLARE_MISS}
                                                                                direction=se,sw
                                                                                hits=no
                                                                                [frame]
                                                                                    begin=-400
                                                                                    end=0
                                                                                    sound=thunderstick-miss.ogg
                                                                                [/frame]
                                                                            [/else]
                                                                            [frame]
                                                                                begin=0
                                                                                end=1
                                                                            [/frame]
                                                                        [/attack_anim]
                                                                    [/effect]
                                                                [/object]
                                                            [/then]
                                                        [/if]
                                                        {THW_UPGRADE_BOUGHT}
                                                    [/then]
                                                    [else]
                                                        {PRINT_THW (You don't have enough gold!)}
                                                    [/else]
                                                [/if]
                                            [/command]
                                        [/option]

                                        [option]
                                            message={MENU_IMG_TXT2 (attacks/hatchet.png) (<big>Teach me how to throw hatchets: 55 coins</big>) (This unit will learn how to throw hatchets, a 9-2 ranged blade attack)}
                                            [command]
                                                [if]
                                                    [variable]
                                                        name=stored_unit_side.gold
                                                        greater_than_equal_to=35
                                                    [/variable]
                                                    [then]
                                                        [gold]
                                                            side=2
                                                            amount=-35
                                                        [/gold]
                                                        [object]
                                                            silent=yes
                                                            [filter]
                                                                x={X}
                                                                y={Y}
                                                            [/filter]
                                                            [effect]
                                                                apply_to=new_attack
                                                                name=hatchet
                                                                description= _ "hatchets"
                                                                range=ranged
                                                                type=blade
                                                                damage=9
                                                                number=2
                                                            [/effect]
                                                            [effect]
                                                                apply_to=new_animation
                                                                name=hatchet
                                                                [attack_anim]
                                                                    [filter_attack]
                                                                        name=hatchet
                                                                    [/filter_attack]
                                                                    {MISSILE_FRAME_HATCHET}
                                                                    [if]
                                                                        hits=yes
                                                                        [frame]
                                                                            begin=-250
                                                                            end=-100
                                                                            sound=hatchet.wav
                                                                        [/frame]
                                                                    [/if]
                                                                    [else]
                                                                        hits=no
                                                                        [frame]
                                                                            begin=-250
                                                                            end=-100
                                                                            sound=hatchet-miss.wav
                                                                        [/frame]
                                                                    [/else]
                                                                    [frame]
                                                                        begin=-100
                                                                        end=0
                                                                    [/frame]
                                                                [/attack_anim]
                                                            [/effect]
                                                        [/object]
                                                        {THW_UPGRADE_BOUGHT}
                                                    [/then]
                                                    [else]
                                                        {PRINT_THW (You don't have enough gold!)}
                                                    [/else]
                                                [/if]
                                            [/command]
                                        [/option]
                                    [/message]
                                [/do]
                            [/while]
                        [/command]
                    [/option]

                    [option]
                        message={MENU_IMG_TXT2 ($shopper.image) ( _ "<big><i><span foreground='yellow'>See exclusive wares</span></i></big>") ( _ "Allows you to buy special upgrades")}
                        [show_if]
                            [have_unit]
                                x={X}
                                y={Y}
                                side=3
                                [filter_wml]
                                    [variables]
                                        original_leader=yes
                                    [/variables]
                                [/filter_wml]
                            [/have_unit]
                        [/show_if]
                        [command]
                            {VARIABLE finished_sub no}
                            [while]
                                [variable]
                                    name=finished_sub
                                    equals=no
                                [/variable]
                                [variable]
                                    name=temp_upgrades_variable
                                    greater_than=0
                                [/variable]
                                [do]
                                    [store_side]
                                        side=$unit.side
                                        variable=stored_unit_side
                                        mode=replace
                                    [/store_side]
                                    [store_unit]
                                        [filter]
                                            x={X}
                                            y={Y}
                                        [/filter]
                                        variable=shopper
                                    [/store_unit]
                                    {VARIABLE temp_upgrades_variable $shopper.variables.upgrades_available}
                                    [unstore_unit]
                                        variable=shopper
                                    [/unstore_unit]
                                    [message]
                                        speaker=narrator
                                        image=wesnoth-icon.png
                                        message= _ "Please choose an enhancement, $unit.name.
<b>Current gold: <span foreground='green'>$stored_unit_side.gold|</span>
You have <span foreground='red'>$temp_upgrades_variable|</span> upgrades remaining</b>"
                                        [option]
                                            message={MENU_IMG_TXT (units/human-loyalists/sergeant-leading.png) ( _ "<big><i><span foreground='yellow'>See the regular upgrades</span></i></big>")}
                                            [command]
                                                {VARIABLE finished_sub yes}
                                            [/command]
                                        [/option]
                                        [option]
                                            message={MENU_IMG_TXT2 (attacks/sword-holy.png) (<big>Imbue my sword with the magical essence of light: 110 coins</big>) (This unit's sword will become magical and gain the magical weapon special, and he will receive the illuminates ability and undead next to him will be weakened)}
                                            [command]
                                                [if]
                                                    [variable]
                                                        name=stored_unit_side.gold
                                                        greater_than_equal_to=110
                                                    [/variable]
                                                    [then]
                                                        [gold]
                                                            side=3
                                                            amount=-110
                                                        [/gold]
                                                        [object]
                                                            silent=yes
                                                            [filter]
                                                                x={X}
                                                                y={Y}
                                                            [/filter]
                                                            [effect]
                                                                apply_to=attack
                                                                name=sword
                                                                set_image=attacks/sword-holy.png
                                                                set_description= _ "light sword"
                                                                set_type=arcane
                                                                [set_specials]
                                                                    mode=append
                                                                    {WEAPON_SPECIAL_MAGICAL}
                                                                [/set_specials]
                                                            [/effect]
                                                            [effect]
                                                                apply_to=new_ability
                                                                [abilities]
                                                                    {ABILITY_ILLUMINATES_THW}
                                                                    {ABILITY_BLESSED}
                                                                [/abilities]
                                                            [/effect]
                                                        [/object]
                                                        {MODIFY_UNIT x,y=$x1,$y1 halo halo/illuminates-aura.png}
                                                        {THW_UPGRADE_BOUGHT}
                                                    [/then]
                                                    [else]
                                                        {PRINT_THW (You don't have enough gold!)}
                                                    [/else]
                                                [/if]
                                            [/command]
                                        [/option]
                                        [option]
                                            message={MENU_IMG_TXT2 (attacks/fireball.png) (<big>Teach me how to use fireballs against my enemies: 70 coins</big>) (This unit will learn how to use fireballs, a 8-3 magical fire ranged attack)}
                                            [command]
                                                [if]
                                                    [variable]
                                                        name=stored_unit_side.gold
                                                        greater_than_equal_to=70
                                                    [/variable]
                                                    [then]
                                                        [gold]
                                                            side=3
                                                            amount=-70
                                                        [/gold]
                                                        [object]
                                                            silent=yes
                                                            [filter]
                                                                x={X}
                                                                y={Y}
                                                            [/filter]
                                                            [effect]
                                                                apply_to=new_attack
                                                                name=fireball
                                                                description= _ "fireball"
                                                                damage=8
                                                                number=3
                                                                range=ranged
                                                                type=fire
                                                                [specials]
                                                                    {WEAPON_SPECIAL_MAGICAL}
                                                                [/specials]
                                                            [/effect]
                                                        [/object]
                                                        [if]
                                                            [have_unit]
                                                                x={X}
                                                                y={Y}
                                                                type=Lieutenant
                                                            [/have_unit]
                                                            [then]
                                                                [object]
                                                                    silent=yes
                                                                    [effect]
                                                                        apply_to=new_animation
                                                                        name=fireball
                                                                        [attack_anim]
                                                                            [filter_attack]
                                                                                name=fireball
                                                                            [/filter_attack]
                                                                            {MISSILE_FRAME_FIREBALL}

                                                                            start_time=-575
                                                                            [frame]
                                                                                duration=50
                                                                            [/frame]
                                                                            [frame]
                                                                                duration=100
                                                                                sound=fire.wav
                                                                            [/frame]
                                                                            [frame]
                                                                                duration=150
                                                                            [/frame]
                                                                            [frame]
                                                                                duration=75
                                                                            [/frame]
                                                                            [frame]
                                                                                duration=75
                                                                            [/frame]
                                                                        [/attack_anim]
                                                                    [/effect]
                                                                [/object]
                                                            [/then]
                                                        [/if]
                                                        {THW_UPGRADE_BOUGHT}
                                                    [/then]
                                                    [else]
                                                        {PRINT_THW (You don't have enough gold!)}
                                                    [/else]
                                                [/if]
                                            [/command]
                                        [/option]
                                    [/message]
                                [/do]
                            [/while]
                        [/command]
                    [/option]

                    [option]
                        message={MENU_IMG_TXT2 (items/sword.png) (<big>Strengthen my melee weapon: 10 coins</big>) (1 melee power increase)}
                        [show_if]
                            [have_unit]
                                x={X}
                                y={Y}
                            [/have_unit]
                            [variable]
                                name=stored_unit_side.gold
                                greater_than_equal_to=10
                            [/variable]
                        [/show_if]
                        [command]
                            [gold]
                                side=$unit.side
                                amount=-10
                            [/gold]
                            [object]
                                silent=yes
                                [filter]
                                    x={X}
                                    y={Y}
                                [/filter]
                                [effect]
                                    apply_to=attack
                                    range=melee
                                    increase_damage=1
                                [/effect]
                            [/object]
                            {THW_UPGRADE_BOUGHT}
                        [/command]
                    [/option]
                    [option]
                        message={MENU_IMG_TXT2 (items/bow.png) (<big>Strengthen my ranged weapon: 10 coins</big>) (1 ranged power increase)}
                        [show_if]
                            [have_unit]
                                x={X}
                                y={Y}
                            [/have_unit]
                            [variable]
                                name=stored_unit_side.gold
                                greater_than_equal_to=10
                            [/variable]
                        [/show_if]
                        [command]
                            [gold]
                                side=$unit.side
                                amount=-10
                            [/gold]
                            [object]
                                [filter]
                                    x={X}
                                    y={Y}
                                [/filter]
                                silent=yes
                                [effect]
                                    apply_to=attack
                                    range=ranged
                                    increase_damage=1
                                [/effect]
                            [/object]
                            {THW_UPGRADE_BOUGHT}
                        [/command]
                    [/option]
                    [option]
                        message={MENU_IMG_TXT2 (items/flame-sword.png) (<big>Give me another melee strike: 35 coins</big>) (1 melee strike increase)}
                        [show_if]
                            [have_unit]
                                x={X}
                                y={Y}
                            [/have_unit]
                            [variable]
                                name=stored_unit_side.gold
                                greater_than_equal_to=35
                            [/variable]
                        [/show_if]
                        [command]
                            [gold]
                                side=$unit.side
                                amount=-35
                            [/gold]
                            [object]
                                [filter]
                                    x={X}
                                    y={Y}
                                [/filter]
                                silent=yes
                                [effect]
                                    apply_to=attack
                                    range=melee
                                    increase_attacks=1
                                [/effect]
                            [/object]
                            {THW_UPGRADE_BOUGHT}
                        [/command]
                    [/option]
                    [option]
                        message={MENU_IMG_TXT2 (items/bow-crystal.png) (<big>Give me another ranged strike: 35 coins</big>) (1 ranged strike increase)}
                        [show_if]
                            [have_unit]
                                x={X}
                                y={Y}
                            [/have_unit]
                            [variable]
                                name=stored_unit_side.gold
                                greater_than_equal_to=35
                            [/variable]
                        [/show_if]
                        [command]
                            [gold]
                                side=$unit.side
                                amount=-35
                            [/gold]
                            [object]
                                [filter]
                                    x={X}
                                    y={Y}
                                [/filter]
                                silent=yes
                                [effect]
                                    apply_to=attack
                                    range=ranged
                                    increase_attacks=1
                                [/effect]
                            [/object]
                            {THW_UPGRADE_BOUGHT}
                        [/command]
                    [/option]
                    [option]
                        message={MENU_IMG_TXT2 (items/ball-blue.png) (<big>Give me another movement point: 20 coins</big>) (1 movepoint increase)}
                        [show_if]
                            [have_unit]
                                x={X}
                                y={Y}
                            [/have_unit]
                            [variable]
                                name=stored_unit_side.gold
                                greater_than_equal_to=20
                            [/variable]
                            [variable]
                                name=shopper.max_moves
                                less_than=9
                            [/variable]
                        [/show_if]
                        [command]
                            [gold]
                                side=$unit.side
                                amount=-20
                            [/gold]
                            [object]
                                [filter]
                                    x={X}
                                    y={Y}
                                [/filter]
                                silent=yes
                                [effect]
                                    apply_to=movement
                                    increase=1
                                [/effect]
                            [/object]
                            {THW_UPGRADE_BOUGHT}
                        [/command]
                    [/option]
                    [option]
                        message={MENU_IMG_TXT2 (items/ball-magenta.png) (<big>Increase my resilience: 20 coins</big>) (10 hitpoints increase)}
                        [show_if]
                            [have_unit]
                                x={X}
                                y={Y}
                            [/have_unit]
                            [variable]
                                name=stored_unit_side.gold
                                greater_than_equal_to=20
                            [/variable]
                        [/show_if]
                        [command]
                            [gold]
                                side=$unit.side
                                amount=-20
                            [/gold]
                            [object]
                                [filter]
                                    x={X}
                                    y={Y}
                                [/filter]
                                silent=yes
                                [effect]
                                    apply_to=hitpoints
                                    increase_total=10
                                    increase=10
                                [/effect]
                            [/object]
                            {THW_UPGRADE_BOUGHT}
                        [/command]
                    [/option]
                    [option]
                        message={MENU_IMG_TXT2 (attacks/glaive.png) (<big>Let me counter enemy melee attacks with precision: 20 coins</big>) (This unit's melee attack will have an 80% chance to hit on defense)}
                        [show_if]
                            [have_unit]
                                x={X}
                                y={Y}
                            [/have_unit]
                            [variable]
                                name=stored_unit_side.gold
                                greater_than_equal_to=20
                            [/variable]
                        [/show_if]
                        [command]
                            [gold]
                                side=$unit.side
                                amount=-20
                            [/gold]
                            [object]
                                silent=yes
                                [filter]
                                    x={X}
                                    y={Y}
                                [/filter]
                                [effect]
                                    apply_to=attack
                                    range=melee
                                    [set_specials]
                                        mode=append
                                        {WEAPON_SPECIAL_COUNTER}
                                    [/set_specials]
                                [/effect]
                            [/object]
                            {THW_UPGRADE_BOUGHT}
                        [/command]
                    [/option]
                    [option]
                        message={MENU_IMG_TXT2 (attacks/lance.png) (<big>Teach me how to charge into battle: 25 coins</big>) (This unit's melee attack will gain the charge weapon special)}
                        [show_if]
                            [have_unit]
                                x={X}
                                y={Y}
                                type=Elvish Scout, Elvish Rider, Elvish Outrider, Cavalryman, Dragoon, Cavalier
                            [/have_unit]
                            [variable]
                                name=stored_unit_side.gold
                                greater_than_equal_to=25
                            [/variable]
                        [/show_if]
                        [command]
                            [gold]
                                side=$unit.side
                                amount=-25
                            [/gold]
                            [object]
                                silent=yes
                                [filter]
                                    x={X}
                                    y={Y}
                                [/filter]
                                [effect]
                                    apply_to=attack
                                    range=melee
                                    [set_specials]
                                        mode=append
                                        {WEAPON_SPECIAL_CHARGE}
                                    [/set_specials]
                                [/effect]
                            [/object]
                            {THW_UPGRADE_BOUGHT}
                        [/command]
                    [/option]
                    [option]
                        message={MENU_IMG_TXT2 (attacks/saber-human.png) (<big>Let me steal experience from my foes with my mind-boggling swordplay: 30 coins</big>) (Each hit this unit does with its sword on offense will take away 1 experience from the defender and add give him 1 experience)}
                        [show_if]
                            [have_unit]
                                x={X}
                                y={Y}
                                has_weapon=sword
                            [/have_unit]
                            [variable]
                                name=stored_unit_side.gold
                                greater_than_equal_to=30
                            [/variable]
                        [/show_if]
                        [command]
                            [gold]
                                side=$unit.side
                                amount=-30
                            [/gold]
                            [object]
                                silent=yes
                                [effect]
                                    apply_to=attack
                                    name=sword
                                    [set_specials]
                                        mode=append
                                        {WEAPON_SPECIAL_MIND_FLAY}
                                    [/set_specials]
                                [/effect]
                            [/object]
                            {THW_UPGRADE_BOUGHT}
                        [/command]
                    [/option]
                    [option]
                        message={MENU_IMG_TXT2 (attacks/whip.png) (<big>Let me steal gold from my enemies: 45 coins</big>) (Each hit of this unit's melee attack on offense will take 3 gold from the defender's side and transfer it to his own side)}
                        [show_if]
                            [have_unit]
                                x={X}
                                y={Y}
                                type=Thief, Rogue, Outlaw, Fugitive, Footpad
                            [/have_unit]
                            [variable]
                                name=stored_unit_side.gold
                                greater_than_equal_to=45
                            [/variable]
                        [/show_if]
                        [command]
                            [gold]
                                side=$unit.side
                                amount=-45
                            [/gold]
                            [object]
                                silent=yes
                                [effect]
                                    apply_to=attack
                                    range=melee
                                    [set_specials]
                                        mode=append
                                        {WEAPON_SPECIAL_PICKPOCKET}
                                    [/set_specials]
                                [/effect]
                            [/object]
                            {THW_UPGRADE_BOUGHT}
                        [/command]
                    [/option]
                    [option]
                        message={MENU_IMG_TXT2 (attacks/touch-faerie.png) (<big>Let me charm enemies with my melee attack: 25 coins</big>) (When this unit hits an enemy male on offense with her melee attack, he will be converted to her side with 2 movepoints and the ability to attack)}
                        [show_if]
                            [have_unit]
                                x={X}
                                y={Y}
                                gender=female
                            [/have_unit]
                            [variable]
                                name=stored_unit_side.gold
                                greater_than_equal_to=25
                            [/variable]
                        [/show_if]
                        [command]
                            [gold]
                                side=$unit.side
                                amount=-25
                            [/gold]
                            [object]
                                silent=yes
                                [effect]
                                    apply_to=attack
                                    range=melee
                                    [set_specials]
                                        mode=append
                                        {WEAPON_SPECIAL_CHARM}
                                    [/set_specials]
                                [/effect]
                            [/object]
                            {THW_UPGRADE_BOUGHT}
                        [/command]
                    [/option]
                    [option]
                        message={MENU_IMG_TXT2 (attacks/frenzy.png) (<big>Let me attack again if I kill an enemy: 50 coins</big>) (When this unit kills an enemy unit on offense, he regains 1 movepoint and the ability to attack again)}
                        [show_if]
                            [have_unit]
                                x={X}
                                y={Y}
                                type=Dwarvish Ulfserker, Dwarvish Berserker
                            [/have_unit]
                            [variable]
                                name=stored_unit_side.gold
                                greater_than_equal_to=50
                            [/variable]
                        [/show_if]
                        [command]
                            [gold]
                                side=$unit.side
                                amount=-50
                            [/gold]
                            [object]
                                silent=yes
                                [effect]
                                    apply_to=attack
                                    range=melee
                                    [set_specials]
                                        mode=append
                                        {WEAPON_SPECIAL_BLOODLUST}
                                    [/set_specials]
                                [/effect]
                            [/object]
                            {THW_UPGRADE_BOUGHT}
                        [/command]
                    [/option]
                    [option]
                        message={MENU_IMG_TXT2 (attacks/morning-star.png) (<big>Let my powerful attack knock enemies back: 30 coins</big>) (This unit's strongest attack will knock back the defender 1 hex when it hits on offense, ending combat)}
                        [show_if]
                            [have_unit]
                                x={X}
                                y={Y}
                                has_weapon=hammer
                                [or]
                                    x={X}
                                    y={Y}
                                    has_weapon=thunderstick
                                [/or]
                                [or]
                                    x={X}
                                    y={Y}
                                    has_weapon=dragonstaff
                                [/or]
                                [or]
                                    x={X}
                                    y={Y}
                                    has_weapon=mace
                                [/or]
                                [or]
                                    x={X}
                                    y={Y}
                                    has_weapon=morning star
                                [/or]
                                [or]
                                    x={X}
                                    y={Y}
                                    has_weapon=crush
                                [/or]
                            [/have_unit]
                            [variable]
                                name=stored_unit_side.gold
                                greater_than_equal_to=30
                            [/variable]
                        [/show_if]
                        [command]
                            [gold]
                                side=$unit.side
                                amount=-30
                            [/gold]
                            [object]
                                silent=yes
                                [effect]
                                    apply_to=attack
                                    name=hammer, thunderstick, mace, morning star, crush, dragonstaff
                                    [set_specials]
                                        mode=append
                                        {WEAPON_SPECIAL_KNOCKBACK}
                                    [/set_specials]
                                [/effect]
                            [/object]
                            {THW_UPGRADE_BOUGHT}
                        [/command]
                    [/option]
                    [option]
                        message={MENU_IMG_TXT2 (attacks/entangle.png) (<big>Teach me how to blend into the forest: 40 coins</big>) (This unit will receive the ambush ability)}
                        [show_if]
                            [have_unit]
                                x={X}
                                y={Y}
                                race=elf
                                [not]
                                    x={X}
                                    y={Y}
                                    ability=ambush
                                [/not]
                            [/have_unit]
                            [variable]
                                name=stored_unit_side.gold
                                greater_than_equal_to=40
                            [/variable]
                        [/show_if]
                        [command]
                            [gold]
                                side=$unit.side
                                amount=-40
                            [/gold]
                            [object]
                                silent=yes
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        {ABILITY_AMBUSH}
                                    [/abilities]
                                [/effect]
                            [/object]
                            {THW_UPGRADE_BOUGHT}
                        [/command]
                    [/option]
                    [option]
                        message={MENU_IMG_TXT2 (attacks/bow.png) (<big>Teach me how to hunt for food: 40 coins</big>) (This unit will receive 5 gold and 2 experience each turn it starts in swamp terrain)}
                        [show_if]
                            [have_unit]
                                x={X}
                                y={Y}
                                type=Bowman
                                [or]
                                    x={X}
                                    y={Y}
                                    type=Poacher
                                [/or]
                                [or]
                                    x={X}
                                    y={Y}
                                    type=Elvish Archer
                                [/or]
                                [or]
                                    x={X}
                                    y={Y}
                                    type=Elvish Avenger
                                [/or]
                                [or]
                                    x={X}
                                    y={Y}
                                    type=Elvish Ranger
                                [/or]
                                [or]
                                    x={X}
                                    y={Y}
                                    type=Elvish Marksman
                                [/or]
                                [or]
                                    x={X}
                                    y={Y}
                                    type=Elvish Sharpshooter
                                [/or]
                                [or]
                                    x={X}
                                    y={Y}
                                    type=Trapper
                                [/or]
                                [or]
                                    x={X}
                                    y={Y}
                                    type=Huntsman
                                [/or]
                                [or]
                                    x={X}
                                    y={Y}
                                    type=Longbowman
                                [/or]
                                [or]
                                    x={X}
                                    y={Y}
                                    type=Ranger
                                [/or]
                                [or]
                                    x={X}
                                    y={Y}
                                    type=Master Bowman
                                [/or]
                                [not]
                                    x={X}
                                    y={Y}
                                    canrecruit=yes
                                [/not]
                            [/have_unit]
                            [variable]
                                name=stored_unit_side.gold
                                greater_than_equal_to=40
                            [/variable]
                        [/show_if]
                        [command]
                            [gold]
                                side=$unit.side
                                amount=-40
                            [/gold]
                            [object]
                                silent=yes
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        {ABILITY_HUNTS_THW}
                                    [/abilities]
                                [/effect]
                            [/object]
                            {THW_UPGRADE_BOUGHT}
                        [/command]
                    [/option]
                    [option]
                        message={MENU_IMG_TXT2 (attacks/thorns.png) (<big>Teach me how to blend into mountains, hills, and caves: 40 coins</big>) (This unit will be able to hide from enemies in hills, mountains, and caves)}
                        [show_if]
                            [have_unit]
                                x={X}
                                y={Y}
                                race=dwarf
                                [not]
                                    x={X}
                                    y={Y}
                                    ability=camoflauge_thw
                                [/not]
                            [/have_unit]
                            [variable]
                                name=stored_unit_side.gold
                                greater_than_equal_to=40
                            [/variable]
                        [/show_if]
                        [command]
                            [gold]
                                side=$unit.side
                                amount=-40
                            [/gold]
                            [object]
                                silent=yes
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        {ABILITY_CAMO_THW}
                                    [/abilities]
                                [/effect]
                            [/object]
                            {THW_UPGRADE_BOUGHT}
                        [/command]
                    [/option]
                    [option]
                        message={MENU_IMG_TXT2 (attacks/gaze.png) (<big>Teach me how to blend into the night: 30 coins</big>) (This unit will receive the nightstalk ability)}
                        [show_if]
                            [have_unit]
                                x={X}
                                y={Y}
                                [filter_wml]
                                    alignment=chaotic
                                [/filter_wml]
                                [not]
                                    x={X}
                                    y={Y}
                                    ability=nightstalk
                                [/not]
                            [/have_unit]
                            [variable]
                                name=stored_unit_side.gold
                                greater_than_equal_to=30
                            [/variable]
                        [/show_if]
                        [command]
                            [gold]
                                side=$unit.side
                                amount=-30
                            [/gold]
                            [object]
                                silent=yes
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        {ABILITY_NIGHTSTALK}
                                    [/abilities]
                                [/effect]
                            [/object]
                            {THW_UPGRADE_BOUGHT}
                        [/command]
                    [/option]
                    [option]
                        message={MENU_IMG_TXT2 (attacks/lightbeam.png) (<big>Sell me a holy amulet: 40 coins</big>) (This unit's melee attack will be arcane)}
                        [show_if]
                            [have_unit]
                                x={X}
                                y={Y}
                                [filter_wml]
                                    alignment=lawful
                                    [not]
                                        [variables]
                                            original_leader=yes
                                        [/variables]
                                    [/not]
                                [/filter_wml]
                            [/have_unit]
                            [variable]
                                name=stored_unit_side.gold
                                greater_than_equal_to=40
                            [/variable]
                        [/show_if]
                        [command]
                            [gold]
                                side=$unit.side
                                amount=-40
                            [/gold]
                            [object]
                                silent=yes
                                [effect]
                                    apply_to=attack
                                    range=melee
                                    set_type=arcane
                                [/effect]
                            [/object]
                            {THW_UPGRADE_BOUGHT}
                        [/command]
                    [/option]
                [/message]
            [/do]
        [/while]
    [/event]
#enddef

#define SELL_XP_OPTION XP_AMOUNT
    [option]
        message={MENU_IMG_TXT lobby/status-lobby-s.png ("<big><b><span foreground='blue'>{XP_AMOUNT}</span></b></big>")}
        [command]
            {VARIABLE_OP sell_xp_amount add {XP_AMOUNT}}
        [/command]
    [/option]
#enddef

#define BUY_XP_OPTION XP_AMOUNT
    [option]
        message={MENU_IMG_TXT lobby/status-lobby-s.png ("<big><b><span foreground='blue'>{XP_AMOUNT}</span></b></big>")}
        [command]
            {VARIABLE_OP buy_xp_amount add {XP_AMOUNT}}
        [/command]
    [/option]
#enddef

#define GOLD_XP_CONVERT_SHOP X Y
    [label]
        x,y={X},{Y}
        text = "<b>Gold-XP</b>"
        immutable=yes
    [/label]
    [item]
        x={X}
        y={Y}
        image=scenery/leanto.png
        halo=halo/saurian-magic-halo-2.png
    [/item]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            x={X}
            y={Y}
            side=1,2,3
        [/filter]
        {VARIABLE xp $unit.experience}
        [store_side]
            mode=replace
            side=$side_number
            variable=shopper_side
        [/store_side]
        {VARIABLE finished no}
        [redraw]
        [/redraw]
        [message]
            speaker=narrator
            image="scenery/leanto.png"
            message= _ "You can use your experience to exchange for gold or use gold to exchange for experience from my shop (<i>but only once each!</i>).

<b>Experience: <span foreground='blue'>$xp|</span>
Gold: <span foreground='green'>$shopper_side.gold|</span></b>"
            [option]
                message= _ "<b>I'm Finished</b>"
                [command]
                [/command]
            [/option]
            [option]
                message= _ "<b><span foreground='blue'>I have experience to exchange for gold</span></b>"
                [show_if]
                    [variable]
                        name=unit.variables.sold_xp
                        not_equals=yes
                    [/variable]
                [/show_if]
                [command]
                    {VARIABLE sell_xp_amount 0}
                    [while]
                        [variable]
                            name=finished
                            equals=no
                        [/variable]
                        [do]
                            [message]
                                speaker=unit
                                message= _ "Each experience point can be sold for 1 gold coin." + "
<b>Experience: <span foreground='blue'>$xp|</span></b>"
                                [option]
                                    message={MENU_IMG_TXT ($unit.image) ( _ "<b><big><span foreground='green'>Sell experience: <u>$sell_xp_amount|</u></span></big></b>")}
                                    [command]
                                        [if]
                                            [variable]
                                                name=unit.experience
                                                greater_than_equal_to=$sell_xp_amount
                                            [/variable]
                                            [then]
                                                {VARIABLE finished yes}
                                                {VARIABLE_OP xp add -$sell_xp_amount}
                                                {MODIFY_UNIT x,y={X},{Y} experience $xp}
                                                {MODIFY_UNIT x,y={X},{Y} variables.sold_xp yes}
                                                [gold]
                                                    side=$side_number
                                                    amount=$sell_xp_amount
                                                [/gold]
                                                {PRINT_THW ( _ "$unit.name| , $unit.type  has sold $sell_xp_amount  experience")}
                                            [/then]
                                            [else]
                                                {NARRATOR_MESSAGE_THW $unit.side ($unit.name does not have $sell_xp_amount experience to exchange.)}
                                                {VARIABLE sell_xp_amount 0}
                                            [/else]
                                        [/if]
                                    [/command]
                                [/option]
                                [option]
                                    message={MENU_IMG_TXT misc/red-x.png ( _ "<b><big><span foreground='red'>Cancel</span></big></b>")}
                                    [command]
                                        {VARIABLE finished yes}
                                        {PRINT_THW ( _ "Please come back again soon.")}
                                    [/command]
                                [/option]
                                {SELL_XP_OPTION 1}
                                {SELL_XP_OPTION 5}
                                {SELL_XP_OPTION 10}
                                {SELL_XP_OPTION 20}
                                {SELL_XP_OPTION 30}
                            [/message]
                        [/do]
                    [/while]
                [/command]
            [/option]
            [option]
                message= _ "<b><span foreground='green'>I have gold to exchange for experience</span></b>"
                [show_if]
                    [variable]
                        name=unit.variables.bought_xp
                        not_equals=yes
                    [/variable]
                [/show_if]
                [command]
                    {VARIABLE buy_xp_amount 0}
                    [store_side]
                        side=$side_number
                        variable=shopper_side
                    [/store_side]
                    [while]
                        [variable]
                            name=finished
                            equals=no
                        [/variable]
                        [do]
                            [message]
                                speaker=unit
                                message= _ "Each experience point costs 2 gold coins." + "
<b>Gold: <span foreground='green'>$shopper_side.gold|</span></b>"
                                [option]
                                    message={MENU_IMG_TXT ($unit.image) ( _ "<b><big><span foreground='green'>Buy experience: <u>$buy_xp_amount|</u></span></big></b>")}
                                    [command]
                                        {VARIABLE buy_xp_cost $buy_xp_amount}
                                        {VARIABLE_OP buy_xp_cost multiply 2}
                                        [if]
                                            [variable]
                                                name=shopper_side.gold
                                                greater_than_equal_to=$buy_xp_cost
                                            [/variable]
                                            [then]
                                                {VARIABLE finished yes}
                                                {VARIABLE_OP xp add $buy_xp_amount}
                                                {MODIFY_UNIT x,y={X},{Y} experience $xp}
                                                {MODIFY_UNIT x,y={X},{Y} variables.bought_xp yes}
                                                [gold]
                                                    side=$side_number
                                                    amount=-$buy_xp_cost
                                                [/gold]
                                                {PRINT_THW ( _ "$unit.name|, $unit.type has bought $buy_xp_amount experience")}
                                            [/then]
                                            [else]
                                                {NARRATOR_MESSAGE_THW $unit.side (You do not have enough gold to buy $buy_xp_amount experience.)}
                                                {VARIABLE buy_xp_amount 0}
                                            [/else]
                                        [/if]
                                    [/command]
                                [/option]
                                [option]
                                    message={MENU_IMG_TXT misc/red-x.png ( _ "<b><big><span foreground='red'>Cancel</span></big></b>")}
                                    [command]
                                        {VARIABLE finished yes}
                                        {PRINT_THW ( _ "Please come back again soon.")}
                                    [/command]
                                [/option]
                                {BUY_XP_OPTION 1}
                                {BUY_XP_OPTION 5}
                                {BUY_XP_OPTION 10}
                                {BUY_XP_OPTION 20}
                                {BUY_XP_OPTION 30}
                            [/message]
                        [/do]
                    [/while]
                [/command]
            [/option]
        [/message]
        {CLEAR_VARIABLE shopper_side}
        {CLEAR_VARIABLE xp}
    [/event]
#enddef

#define POTION_SHOP_MOVETO_STUFF X Y SIDE
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x={X}
            y={Y}
            side={SIDE}
        [/filter]
        {VARIABLE finished no}
        [store_side]
            side=$side_number
            variable=stored_side_info
        [/store_side]
        [if]
            [variable]
                name=stored_side_info.controller
                equals=ai
            [/variable]
            [then]
                {VARIABLE finished yes}
            [/then]
        [/if]
        [while]
            [variable]
                name=finished
                equals=no
            [/variable]
            [do]
                [store_side]
                    side=$side_number
                    variable=stored_side_info
                [/store_side]
                [message]
                    speaker=narrator
                    image=wesnoth-icon.png
                    message= _ "Please buy a potion:" + "
<b><tt><span foreground='green'>Current gold:" + "$stored_side_info.gold|</span>" + "
Currently carrying:" + "${SIDE}total_potions|
Health Potions:" + "${SIDE}heal_potions|" + "
Speed Potions:" + "${SIDE}speed_potions|" + "
Strength Potions:" + "${SIDE}strength_potions|" + "
Intelligence Potions:" + "${SIDE}intelligence_potions|" + "
Poison Potions:" + "${SIDE}poison_potions|</tt></b>"
                    [option]
                        message= _ "<b>I'm Finished</b>"
                        [command]
                            {VARIABLE finished yes}
                        [/command]
                    [/option]
                    [option]
                        message={MENU_IMG_TXT items/potion-red.png ( _ "Potion of healing, 25 coins: instant full heal")}
                        [show_if]
                            [variable]
                                name=stored_side_info.gold
                                greater_than_equal_to=25
                            [/variable]
                        [/show_if]
                        [command]
                            {VARIABLE_OP {SIDE}total_potions add 1}
                            {VARIABLE_OP {SIDE}heal_potions add 1}
                            [gold]
                                side=$side_number
                                amount=-25
                            [/gold]
                        [/command]
                    [/option]
                    [option]
                        message={MENU_IMG_TXT items/potion-grey.png ( _ "Potion of speed, 25 coins: 15 movepoints")}
                        [show_if]
                            [variable]
                                name=stored_side_info.gold
                                greater_than_equal_to=25
                            [/variable]
                        [/show_if]
                        [command]
                            {VARIABLE_OP {SIDE}total_potions add 1}
                            {VARIABLE_OP {SIDE}speed_potions add 1}
                            [gold]
                                side=$side_number
                                amount=-25
                            [/gold]
                        [/command]
                    [/option]
                    [option]
                        message={MENU_IMG_TXT items/potion-yellow.png ( _ "Potion of strength, 25 coins: +6 attack power")}
                        [show_if]
                            [variable]
                                name=stored_side_info.gold
                                greater_than_equal_to=25
                            [/variable]
                        [/show_if]
                        [command]
                            {VARIABLE_OP {SIDE}total_potions add 1}
                            {VARIABLE_OP {SIDE}strength_potions add 1}
                            [gold]
                                side=$side_number
                                amount=-25
                            [/gold]
                        [/command]
                    [/option]
                    [option]
                        message={MENU_IMG_TXT items/potion-blue.png ( _ "Potion of intelligence, 25 coins: 6 experience")}
                        [show_if]
                            [variable]
                                name=stored_side_info.gold
                                greater_than_equal_to=25
                            [/variable]
                        [/show_if]
                        [command]
                            {VARIABLE_OP {SIDE}total_potions add 1}
                            {VARIABLE_OP {SIDE}intelligence_potions add 1}
                            [gold]
                                side=$side_number
                                amount=-25
                            [/gold]
                        [/command]
                    [/option]
                    [option]
                        message={MENU_IMG_TXT items/potion-poison.png ( _ "Potion of poison, 25 coins: poison on all weapons")}
                        image="items/potion-blue.png"
                        [show_if]
                            [variable]
                                name=stored_side_info.gold
                                greater_than_equal_to=25
                            [/variable]
                        [/show_if]
                        [command]
                            {VARIABLE_OP {SIDE}total_potions add 1}
                            {VARIABLE_OP {SIDE}poison_potions add 1}
                            {MODIFY_UNIT x,y={X},{Y} status.poisoned yes}
                            [floating_text]
                                x,y={X},{Y}
                                text="sick"
                            [/floating_text]
                            [gold]
                                side=$side_number
                                amount=-25
                            [/gold]
                        [/command]
                    [/option]
                [/message]
            [/do]
        [/while]
        {PRINT_THW (Please come back again soon.)}
    [/event]
#enddef

#define POTION_SHOP X Y
    [label]
        x,y={X},{Y}
        text = "<b>Potions</b>"
        immutable=yes
    [/label]
    [item]
        x={X}
        y={Y}
        image=scenery/tent-shop-weapons.png
        halo=halo/undead/black-magic-2.png
    [/item]
    {POTION_SHOP_MOVETO_STUFF {X} {Y} 1}
    {POTION_SHOP_MOVETO_STUFF {X} {Y} 2}
    {POTION_SHOP_MOVETO_STUFF {X} {Y} 3}
#enddef
